# ExploitGuardNetworkProtectionBlocked Generated on Device

### [+] Defender for Endpoint 
```
DeviceEvents
| where ActionType in~ ('ExploitGuardNetworkProtectionBlocked', 'ExploitGuardNetworkProtectionAudited')
| extend ResponseCategory = tostring(parse_json(AdditionalFields).ResponseCategory),
         DisplayName = tostring(parse_json(AdditionalFields).DisplayName)
// "CustomPolicy" may cause a lot of false positives, so removing excluding may find better results
| where ResponseCategory != "CustomBlockList" and ResponseCategory  != "CustomPolicy" 
| summarize ClickCount = count(), 
            Timestamp = max(Timestamp), 
            InitiatingProcessAccountUpn = make_set(InitiatingProcessAccountUpn),
            ActionType = make_set(ActionType),
            RemoteUrl = make_set(RemoteUrl),
            ResponseCategory = make_set(ResponseCategory),
            DisplayName = make_set(DisplayName)
    by DeviceName
| project Timestamp, DeviceName, ClickCount, 
          tostring(InitiatingProcessAccountUpn[0]), 
          tostring(ActionType[0]), 
          tostring(RemoteUrl[0]), 
          tostring(ResponseCategory[0]), 
          tostring(DisplayName[0])
| sort by ClickCount desc
```

### Microsoft Sentinel KQL
```
DeviceEvents
| where ActionType in~ ('ExploitGuardNetworkProtectionBlocked', 'ExploitGuardNetworkProtectionAudited')
| extend ResponseCategory = tostring(parse_json(AdditionalFields).ResponseCategory),
         DisplayName = tostring(parse_json(AdditionalFields).DisplayName)
// "CustomPolicy" may cause a lot of false positives, so removing excluding may find better results
| where ResponseCategory != "CustomBlockList" and ResponseCategory  != "CustomPolicy"
| summarize ClickCount = count(), 
            Timestamp = max(TimeGenerated), 
            InitiatingProcessAccountUpn = make_set(InitiatingProcessAccountUpn),
            ActionType = make_set(ActionType),
            RemoteUrl = make_set(RemoteUrl),
            ResponseCategory = make_set(ResponseCategory),
            DisplayName = make_set(DisplayName)
    by DeviceName
| project Timestamp, DeviceName, ClickCount, 
          tostring(InitiatingProcessAccountUpn[0]), 
          tostring(ActionType[0]), 
          tostring(RemoteUrl[0]), 
          tostring(ResponseCategory[0]), 
          tostring(DisplayName[0])
| sort by ClickCount desc
```
:exclamation: *You will need to turn on **Microsoft 365 Defender** or **Microsoft Defender for Endpoint** Data connector on Sentinel in order for this KQL to work.*

### [+] Description 
This alert is triggered when a single device generates a high number of ExploitGuard network protection events within a specified time period. The alert groups the events by device and counts the number of events for each device. Devices with a high count of events may indicate malicious activity and should be investigated further. Not ideal to create a custom detection or analytics rule, this will generate a lot of alerts. 

### [+] Recommended Actions
1. Investigate the devices with a high count of ExploitGuard network protection events to determine if the activity is malicious.
2. Analyze the details provided in the alert, such as the timestamp, initiating process account UPN, action type, and remote URL, to understand the nature of the activity.
3. Check the display name and response category to verify whether the event was blocked or audited by the ExploitGuard Network Protection feature of Microsoft Defender for Endpoint.
4. If the activity is found to be malicious, isolate the affected devices and perform a thorough investigation to identify the scope of the attack and take necessary remediation steps.

### [+] Resources
- [Microsoft Network Protection](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/network-protection?view=o365-worldwide)
